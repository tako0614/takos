// Prisma schema for Cloudflare D1 (SQLite)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  // Local development only. Runtime on Workers uses D1Adapter and ignores this.
  url      = "file:./dev.db"
}

model users {
  id                   String    @id // canonical handle
  display_name         String
  avatar_url           String    @default("")
  created_at           DateTime
  is_private           Int       @default(1)
  profile_completed_at DateTime?
  jwt_secret           String? // JWT secret for this user (instance)

  // ActivityPub fields
  summary                     String? // Bio/profile description
  manually_approves_followers Int     @default(0) // Require approval for followers

  // Relations
  accounts                 user_accounts[]
  friend_requests_received friendships[]           @relation("addressee")
  friend_requests_sent     friendships[]           @relation("requester")
  created_communities      communities[]           @relation("community_creator")
  memberships              memberships[]
  invites_created          invites[]               @relation("invite_creator")
  member_invites_sent      member_invites[]        @relation("inviter")
  member_invites_received  member_invites[]        @relation("invitee")
  posts                    posts[]                 @relation("post_author")
  post_reactions           post_reactions[]
  comments                 comments[]
  stories                  stories[]               @relation("story_author")
  dm_messages              chat_dm_messages[]
  channel_messages         chat_channel_messages[]
  notifications            notifications[]         @relation("notification_recipient")
  push_devices             push_devices[]
  sessions                 sessions[]
  ap_keypairs              ap_keypairs?

  @@map("users")
}

model communities {
  id            String   @id
  name          String
  icon_url      String   @default("")
  visibility    String   @default("private")
  description   String   @default("")
  invite_policy String   @default("owner_mod") // 'owner_mod' | 'members'
  created_by    String
  created_at    DateTime

  // ActivityPub fields
  ap_id String? @unique // Group Actor URI

  // Relations
  creator     users         @relation("community_creator", fields: [created_by], references: [id], onDelete: Cascade)
  memberships memberships[]
  invites     invites[]
  posts       posts[]       @relation("community_posts")
  stories     stories[]     @relation("community_stories")
  channels    channels[]

  @@map("communities")
}

model memberships {
  community_id String
  user_id      String
  role         String
  nickname     String   @default("")
  joined_at    DateTime
  status       String   @default("active")

  // Relations
  community communities @relation(fields: [community_id], references: [id], onDelete: Cascade)
  user      users       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([community_id, user_id])
  @@map("memberships")
}

model invites {
  code         String    @id
  community_id String
  expires_at   DateTime?
  created_by   String
  max_uses     Int       @default(0)
  uses         Int       @default(0)
  active       Int       @default(1)

  // Relations
  community communities @relation(fields: [community_id], references: [id], onDelete: Cascade)
  creator   users       @relation("invite_creator", fields: [created_by], references: [id], onDelete: Cascade)

  @@map("invites")
}

model member_invites {
  id              String   @id
  community_id    String
  invited_user_id String
  invited_by      String
  status          String   @default("pending") // 'pending' | 'accepted' | 'declined' | 'canceled'
  created_at      DateTime

  // Relations
  inviter users @relation("inviter", fields: [invited_by], references: [id], onDelete: Cascade)
  invitee users @relation("invitee", fields: [invited_user_id], references: [id], onDelete: Cascade)

  @@map("member_invites")
}

model channels {
  id           String
  community_id String
  name         String
  created_at   DateTime

  // Relations
  community communities @relation(fields: [community_id], references: [id], onDelete: Cascade)

  @@id([id, community_id])
  @@map("channels")
}

model posts {
  id                      String   @id
  community_id            String?
  author_id               String
  type                    String
  text                    String   @default("")
  media_json              String   @default("[]")
  created_at              DateTime
  pinned                  Int      @default(0)
  broadcast_all           Int      @default(0)
  visible_to_friends      Int      @default(0)
  attributed_community_id String?

  // ActivityPub fields
  ap_object_id     String? @unique // ActivityPub Object URI
  ap_attributed_to String? // Remote actor URI for federated posts
  in_reply_to      String? // Reply target Object URI
  ap_activity_id   String? @unique // Create Activity URI

  // Relations
  author    users            @relation("post_author", fields: [author_id], references: [id], onDelete: Cascade)
  community communities?     @relation("community_posts", fields: [community_id], references: [id], onDelete: Cascade)
  reactions post_reactions[]
  comments  comments[]
  announces ap_announces[]

  @@map("posts")
}

model post_reactions {
  id         String   @id
  post_id    String
  user_id    String
  emoji      String
  created_at DateTime

  // ActivityPub fields
  ap_activity_id String? @unique // Like Activity URI

  // Relations
  post posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("post_reactions")
}

model comments {
  id         String   @id
  post_id    String
  author_id  String
  text       String
  created_at DateTime

  // ActivityPub fields
  ap_object_id   String? @unique // ActivityPub Object URI
  ap_activity_id String? @unique // Create Activity URI

  // Relations
  post   posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  author users @relation(fields: [author_id], references: [id], onDelete: Cascade)

  @@map("comments")
}

model stories {
  id                      String   @id
  community_id            String?
  author_id               String
  created_at              DateTime
  expires_at              DateTime
  items_json              String
  broadcast_all           Int      @default(1)
  visible_to_friends      Int      @default(1)
  attributed_community_id String?

  // Relations
  author    users        @relation("story_author", fields: [author_id], references: [id], onDelete: Cascade)
  community communities? @relation("community_stories", fields: [community_id], references: [id], onDelete: Cascade)

  @@map("stories")
}

model friendships {
  requester_id String
  addressee_id String
  status       String // 'pending' | 'accepted' | 'rejected'
  created_at   DateTime

  requester users @relation("requester", fields: [requester_id], references: [id])
  addressee users @relation("addressee", fields: [addressee_id], references: [id])

  @@id([requester_id, addressee_id])
  @@map("friendships")
}

model user_accounts {
  id                  String   @id
  user_id             String
  provider            String
  provider_account_id String
  created_at          DateTime @default(now())
  updated_at          DateTime @default(now())

  user users @relation(fields: [user_id], references: [id])

  @@unique([provider, provider_account_id])
  @@index([user_id])
  @@map("user_accounts")
}

model chat_dm_threads {
  id                String   @id
  participants_hash String   @unique
  participants_json String
  created_at        DateTime @default(now())

  messages chat_dm_messages[]

  @@map("chat_dm_threads")
}

model chat_dm_messages {
  id                String   @id
  thread_id         String
  author_id         String
  content_html      String
  raw_activity_json String
  created_at        DateTime @default(now())

  // Relations
  thread chat_dm_threads @relation(fields: [thread_id], references: [id], onDelete: Cascade)
  author users           @relation(fields: [author_id], references: [id], onDelete: Cascade)

  @@index([thread_id, created_at])
  @@map("chat_dm_messages")
}

model chat_channel_messages {
  id                String   @id
  community_id      String
  channel_id        String
  author_id         String
  content_html      String
  raw_activity_json String
  created_at        DateTime @default(now())

  // Relations
  author users @relation(fields: [author_id], references: [id], onDelete: Cascade)

  @@index([community_id, channel_id, created_at])
  @@map("chat_channel_messages")
}

model notifications {
  id         String   @id
  user_id    String // recipient
  type       String // 'friend_request' | 'friend_accepted' | 'like' | 'comment'
  actor_id   String
  ref_type   String // 'post' | 'comment' | 'user'
  ref_id     String
  message    String   @default("")
  created_at DateTime
  read       Int      @default(0)

  // Relations
  recipient users @relation("notification_recipient", fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ActivityPub Announce/Boost tracking
model ap_announces {
  id            String   @id
  activity_id   String   @unique // Announce Activity URI
  actor_id      String // Who announced/boosted
  object_id     String // Object URI (post being boosted)
  local_post_id String? // FK to posts.id if local post
  created_at    DateTime

  // Relations
  post posts? @relation(fields: [local_post_id], references: [id], onDelete: Cascade)

  @@index([local_post_id])
  @@index([actor_id])
  @@map("ap_announces")
}

model push_devices {
  id          String   @id
  user_id     String
  token       String   @unique
  platform    String
  device_name String   @default("")
  locale      String   @default("")
  created_at  DateTime
  updated_at  DateTime

  // Relations
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("push_devices")
}

model sessions {
  id         String    @id
  user_id    String
  created_at DateTime
  last_seen  DateTime
  expires_at DateTime?

  // Relations
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("sessions")
}

// ============================================
// ActivityPub Tables
// ============================================

// Remote actors (federated users from other instances)
model ap_actors {
  id              String    @id // Full Actor URI: https://bob.example.com/ap/users/bob
  handle          String // username part: bob
  domain          String // instance domain: example.com
  type            String    @default("Person") // Person, Group, Service
  display_name    String
  summary         String? // Bio/description
  icon_url        String?
  inbox_url       String
  outbox_url      String
  followers_url   String?
  following_url   String?
  public_key_pem  String // PEM format public key
  public_key_id   String // Key identifier URI
  created_at      DateTime
  updated_at      DateTime
  last_fetched_at DateTime? // Last time we fetched actor info

  @@unique([handle, domain])
  @@index([domain])
  @@map("ap_actors")
}

// Following relationships (local user follows remote actor)
model ap_follows {
  id              String    @id
  local_user_id   String // FK to users.id
  remote_actor_id String // FK to ap_actors.id
  activity_id     String    @unique // Follow Activity URI
  status          String    @default("pending") // pending, accepted, rejected
  created_at      DateTime
  accepted_at     DateTime?

  @@unique([local_user_id, remote_actor_id])
  @@index([local_user_id])
  @@index([remote_actor_id])
  @@map("ap_follows")
}

// Follower relationships (remote actor follows local user)
model ap_followers {
  id              String    @id
  local_user_id   String // FK to users.id
  remote_actor_id String // FK to ap_actors.id
  activity_id     String    @unique // Follow Activity URI
  status          String    @default("pending") // pending, accepted, rejected
  created_at      DateTime
  accepted_at     DateTime?

  @@unique([local_user_id, remote_actor_id])
  @@index([local_user_id])
  @@index([remote_actor_id])
  @@map("ap_followers")
}

// Inbox activities (received from remote instances)
model ap_inbox_activities {
  id              String    @id
  local_user_id   String // Recipient user
  remote_actor_id String? // Sender actor (nullable for certain activity types)
  activity_id     String // Activity URI
  activity_type   String // Follow, Create, Like, Announce, etc.
  activity_json   String // Full Activity JSON
  status          String    @default("pending") // pending, processing, processed, failed
  error_message   String?
  created_at      DateTime
  processed_at    DateTime?

  @@unique([local_user_id, activity_id])
  @@index([local_user_id])
  @@index([status])
  @@index([activity_id])
  @@map("ap_inbox_activities")
}

// Outbox activities (sent to remote instances)
model ap_outbox_activities {
  id            String   @id
  local_user_id String // Sender user
  activity_id   String   @unique // Activity URI
  activity_type String // Create, Update, Delete, Follow, Like, Announce, etc.
  activity_json String // Full Activity JSON
  object_id     String? // Object URI (if applicable)
  object_type   String? // Note, Article, etc.
  created_at    DateTime

  @@index([local_user_id])
  @@index([created_at])
  @@map("ap_outbox_activities")
}

// Keypairs for HTTP Signatures (one per user)
model ap_keypairs {
  user_id         String   @id // FK to users.id
  public_key_pem  String // PEM format
  private_key_pem String // PEM format (consider encryption)
  created_at      DateTime

  // Relations
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("ap_keypairs")
}

// Remote instance metadata
model ap_instances {
  domain          String   @id // e.g., mastodon.social
  software        String? // mastodon, misskey, etc.
  version         String?
  last_checked_at DateTime

  @@map("ap_instances")
}

// Delivery queue for outgoing activities
model ap_delivery_queue {
  id               String    @id
  activity_id      String // FK to ap_outbox_activities.activity_id
  target_inbox_url String
  attempts         Int       @default(0)
  max_attempts     Int       @default(3)
  status           String    @default("pending") // pending, delivered, failed
  last_attempt_at  DateTime?
  next_attempt_at  DateTime?
  error_message    String?
  created_at       DateTime
  retry_count      Int       @default(0) // For compatibility with existing code
  delivered_at     DateTime? // For compatibility with existing code
  last_error       String? // For compatibility with existing code

  @@unique([activity_id, target_inbox_url])
  @@index([status])
  @@index([next_attempt_at])
  @@map("ap_delivery_queue")
}
