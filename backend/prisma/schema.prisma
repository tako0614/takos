// Prisma schema for takos - Minimal Core Schema
// All other features are implemented in App layer

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ============================================
// Core: Actors (Users and other AP actors)
// ============================================

model actors {
  id                          String    @id // ActivityPub Actor URI (local: https://domain/ap/actors/{handle})
  // Local short id / handle for lookup (legacy user id)
  local_id                    String?   @unique
  handle                      String    @unique
  type                        String    @default("Person") // Person, Group, Service, Application
  display_name                String?
  summary                     String?
  avatar_url                  String?
  header_url                  String?
  inbox                       String?
  outbox                      String?
  followers                   String?
  following                   String?
  public_key_pem              String?
  private_key_pem             String?
  is_local                    Int       @default(1)
  is_bot                      Int       @default(0)
  manually_approves_followers Int       @default(0)
  discoverable                Int       @default(1)
  // Auth / ownership (v1.8 compat)
  owner_id                    String?
  visibility                  String?
  profile_completed_at        DateTime?
  jwt_secret                  String?
  password_hash               String?
  metadata_json               String?   // Additional AP properties as JSON
  created_at                  DateTime  @default(now())
  updated_at                  DateTime?

  // Relations
  follows_outgoing  follows[]       @relation("follows_follower")
  follows_incoming  follows[]       @relation("follows_following")
  notifications     notifications[]
  push_devices      push_devices[]
  sessions          sessions[]

  @@index([type])
  @@index([is_local])
  @@index([owner_id])
}

// ============================================
// Core: User Accounts (optional auth providers)
// ============================================

model user_accounts {
  id                  String   @id
  actor_id            String
  provider            String
  provider_account_id String
  password_hash       String?
  created_at          DateTime @default(now())
  updated_at          DateTime @default(now())

  @@unique([provider, provider_account_id])
  @@index([actor_id])
}

// ============================================
// Core: Media metadata (used when R2 not available)
// ============================================

model media {
  key          String   @id
  actor_id     String
  url          String
  description  String   @default("")
  content_type String   @default("")
  ref_count    Int      @default(0)
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now())

  @@index([actor_id])
  @@index([url])
}

// ============================================
// Core: Object recipients (for direct / followers)
// ============================================

model object_recipients {
  id             String @id @default(uuid())
  object_id       String
  recipient       String
  recipient_type  String

  @@unique([object_id, recipient, recipient_type])
  @@index([object_id])
  @@index([recipient])
}

// ============================================
// Core: Blocks / Mutes (legacy compat; App may override)
// ============================================

model blocks {
  blocker_id String
  blocked_id String

  @@id([blocker_id, blocked_id])
  @@index([blocker_id])
  @@index([blocked_id])
}

model mutes {
  muter_id String
  muted_id String

  @@id([muter_id, muted_id])
  @@index([muter_id])
  @@index([muted_id])
}

// ============================================
// Core: Follows (Follow relationships)
// ============================================

model follows {
  id           String    @id @default(uuid())
  follower_id  String
  following_id String
  status       String    @default("pending") // pending, accepted, rejected
  activity_id  String?   @unique // ActivityPub Follow activity URI
  created_at   DateTime  @default(now())
  accepted_at  DateTime?

  follower  actors @relation("follows_follower", fields: [follower_id], references: [id], onDelete: Cascade)
  following actors @relation("follows_following", fields: [following_id], references: [id], onDelete: Cascade)

  @@unique([follower_id, following_id])
  @@index([follower_id])
  @@index([following_id])
  @@index([status])
}

// ============================================
// Core: Objects (All ActivityPub objects)
// ============================================

model objects {
  id          String   @id // ActivityPub Object URI
  local_id    String?  @unique // Local short ID for URL
  type        String   // Note, Article, Question, Image, Video, Audio, Event, etc.
  actor       String   // attributedTo - Actor URI
  published   String?
  updated     String?
  to          String?  // JSON array
  cc          String?  // JSON array
  bto         String?  // JSON array
  bcc         String?  // JSON array
  audience    String?  // JSON array
  context     String?  // Conversation thread ID
  in_reply_to String?  // Reply target Object URI
  content     String   // Full AP object as JSON
  summary     String?  // Content warning / spoiler text
  sensitive   Int      @default(0)
  is_local    Int      @default(1)
  visibility  String   @default("public") // public, unlisted, followers, direct
  deleted_at  String?
  created_at  DateTime @default(now())

  @@index([type])
  @@index([actor])
  @@index([published(sort: Desc)])
  @@index([context])
  @@index([in_reply_to])
  @@index([visibility])
  @@index([is_local])
  @@index([deleted_at])
  @@index([visibility, published(sort: Desc)])
}

// ============================================
// Core: Notifications
// ============================================

model notifications {
  id           String   @id @default(uuid())
  recipient_id String
  type         String   // follow_request, follow_accepted, mention, reply, like, announce, etc.
  actor_id     String?  // Who triggered the notification
  object_id    String?  // Related object URI
  ref_type     String?
  ref_id       String?
  message      String   @default("")
  data_json    String?  // Additional data as JSON
  read         Int      @default(0)
  created_at   DateTime @default(now())

  recipient actors @relation(fields: [recipient_id], references: [id], onDelete: Cascade)

  @@index([recipient_id])
  @@index([recipient_id, read])
  @@index([created_at(sort: Desc)])
}

// ============================================
// Core: Push Devices
// ============================================

model push_devices {
  id          String   @id @default(uuid())
  actor_id    String
  token       String   @unique
  platform    String   // ios, android, web
  device_name String   @default("")
  locale      String   @default("")
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now())

  actor actors @relation(fields: [actor_id], references: [id], onDelete: Cascade)

  @@index([actor_id])
}

// ============================================
// Core: Sessions (Authentication)
// ============================================

model sessions {
  id         String    @id @default(uuid())
  actor_id   String
  created_at DateTime  @default(now())
  last_seen  DateTime  @default(now())
  expires_at DateTime?

  actor actors @relation(fields: [actor_id], references: [id], onDelete: Cascade)

  @@index([actor_id])
  @@index([expires_at])
}

// ============================================
// Core: Owner Password (Single-user auth)
// ============================================

model owner_password {
  id            Int      @id @default(1)
  password_hash String
  updated_at    DateTime @default(now())
}

// ============================================
// ActivityPub: Delivery Queue
// ============================================

model ap_delivery_queue {
  id               String    @id @default(uuid())
  activity_json    String    // Full activity to deliver
  target_inbox     String    // Target inbox URL
  attempts         Int       @default(0)
  max_attempts     Int       @default(5)
  status           String    @default("pending") // pending, delivered, failed
  last_attempt_at  DateTime?
  next_attempt_at  DateTime?
  error_message    String?
  created_at       DateTime  @default(now())

  @@index([status])
  @@index([next_attempt_at])
}

// ============================================
// ActivityPub: Instance metadata cache
// ============================================

model ap_instances {
  domain          String   @id
  software        String?
  version         String?
  last_checked_at DateTime @default(now())
}

// ============================================
// ActivityPub: Rate limiting
// ============================================

model ap_rate_limits {
  id           String @id @default(uuid())
  key          String
  window_start Int
  created_at   Int

  @@index([key, window_start])
}

// ============================================
// Core: Tamper-evident Audit Log Chain
// ============================================

model audit_log {
  id           String   @id @default(uuid())
  timestamp    DateTime
  actor_type   String
  actor_id     String?
  action       String
  target       String?
  details_json String?
  checksum     String
  prev_checksum String?
  created_at   DateTime

  @@index([timestamp(sort: Desc)])
  @@index([action])
  @@index([actor_type])
  @@index([actor_id])
}
