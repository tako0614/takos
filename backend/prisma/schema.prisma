// Prisma schema for Cloudflare D1 (SQLite)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  // Connection details are defined via prisma.config.ts for migrate tooling.
}

model users {
  id                   String    @id // canonical handle
  display_name         String
  avatar_url           String    @default("")
  created_at           DateTime
  is_private           Int       @default(1)
  profile_completed_at DateTime?
  jwt_secret           String? // JWT secret for this user (instance)

  // ActivityPub fields
  summary                     String? // Bio/profile description
  manually_approves_followers Int     @default(0) // Require approval for followers

  // Relations
  accounts                user_accounts[]
  created_communities     communities[]           @relation("community_creator")
  memberships             memberships[]
  invites_created         invites[]               @relation("invite_creator")
  member_invites_sent     member_invites[]        @relation("inviter")
  member_invites_received member_invites[]        @relation("invitee")
  posts                   posts[]                 @relation("post_author")
  post_reactions          post_reactions[]
  comments                comments[]
  stories                 stories[]               @relation("story_author")
  dm_messages             chat_dm_messages[]
  channel_messages        chat_channel_messages[]
  notifications           notifications[]         @relation("notification_recipient")
  push_devices            push_devices[]
  sessions                sessions[]
  ap_keypairs             ap_keypairs?
  post_reposts            post_reposts[]
  post_bookmarks          post_bookmarks[]
  lists                   lists[]
  list_memberships        list_members[]
  post_plans              post_plans[]
  post_edits              post_edit_history[]
  poll_votes              post_poll_votes[]
  mentioned_in            post_mentions[]
  blocks_initiated        user_blocks[]           @relation("user_blocks_blocker")
  blocks_received         user_blocks[]           @relation("user_blocks_blocked")
  mutes_initiated         user_mutes[]            @relation("user_mutes_muter")
  mutes_received          user_mutes[]            @relation("user_mutes_muted")
  data_exports            data_export_requests[]

  @@map("users")
}

model communities {
  id            String   @id
  name          String
  icon_url      String   @default("")
  visibility    String   @default("private")
  description   String   @default("")
  invite_policy String   @default("owner_mod") // 'owner_mod' | 'members'
  created_by    String
  created_at    DateTime

  // ActivityPub fields
  ap_id String? @unique // Group Actor URI

  // Relations
  creator     users         @relation("community_creator", fields: [created_by], references: [id], onDelete: Cascade)
  memberships memberships[]
  invites     invites[]
  posts       posts[]       @relation("community_posts")
  stories     stories[]     @relation("community_stories")
  channels    channels[]
  post_plans  post_plans[]

  @@map("communities")
}

model memberships {
  community_id String
  user_id      String
  role         String
  nickname     String   @default("")
  joined_at    DateTime
  status       String   @default("active")

  // Relations
  community communities @relation(fields: [community_id], references: [id], onDelete: Cascade)
  user      users       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([community_id, user_id])
  @@map("memberships")
}

model lists {
  id          String   @id
  owner_id    String
  name        String
  description String   @default("")
  is_public   Int      @default(0)
  created_at  DateTime
  updated_at  DateTime

  // Relations
  owner   users          @relation(fields: [owner_id], references: [id], onDelete: Cascade)
  members list_members[]

  @@map("lists")
}

model list_members {
  list_id  String
  user_id  String
  added_at DateTime

  // Relations
  list lists @relation(fields: [list_id], references: [id], onDelete: Cascade)
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([list_id, user_id])
  @@map("list_members")
}

model invites {
  code         String    @id
  community_id String
  expires_at   DateTime?
  created_by   String
  max_uses     Int       @default(0)
  uses         Int       @default(0)
  active       Int       @default(1)

  // Relations
  community communities @relation(fields: [community_id], references: [id], onDelete: Cascade)
  creator   users       @relation("invite_creator", fields: [created_by], references: [id], onDelete: Cascade)

  @@map("invites")
}

model member_invites {
  id              String   @id
  community_id    String
  invited_user_id String
  invited_by      String
  status          String   @default("pending") // 'pending' | 'accepted' | 'declined' | 'canceled'
  created_at      DateTime

  // Relations
  inviter users @relation("inviter", fields: [invited_by], references: [id], onDelete: Cascade)
  invitee users @relation("invitee", fields: [invited_user_id], references: [id], onDelete: Cascade)

  @@map("member_invites")
}

model channels {
  id           String
  community_id String
  name         String
  created_at   DateTime

  // Relations
  community communities @relation(fields: [community_id], references: [id], onDelete: Cascade)

  @@id([id, community_id])
  @@map("channels")
}

model posts {
  id                      String   @id
  community_id            String?
  author_id               String
  type                    String
  text                    String   @default("")
  content_warning         String?
  sensitive               Int      @default(0)
  media_json              String   @default("[]")
  created_at              DateTime
  pinned                  Int      @default(0)
  broadcast_all           Int      @default(0)
  visible_to_friends      Int      @default(0)
  edit_count              Int      @default(0)
  attributed_community_id String?

  // ActivityPub fields
  ap_object_id     String? @unique // ActivityPub Object URI
  ap_attributed_to String? // Remote actor URI for federated posts
  in_reply_to      String? // Reply target Object URI
  ap_activity_id   String? @unique // Create Activity URI

  // Relations
  author        users               @relation("post_author", fields: [author_id], references: [id], onDelete: Cascade)
  community     communities?        @relation("community_posts", fields: [community_id], references: [id], onDelete: Cascade)
  reactions     post_reactions[]
  comments      comments[]
  announces     ap_announces[]
  hashtags      post_hashtags[]
  mentions      post_mentions[]
  reposts       post_reposts[]
  bookmarks_rel post_bookmarks[]
  edit_history  post_edit_history[]
  poll          post_polls?

  @@map("posts")
}

model post_plans {
  id                      String    @id
  author_id               String
  community_id            String?
  type                    String
  text                    String    @default("")
  media_json              String    @default("[]")
  status                  String    @default("draft") // draft | scheduled | published | failed | canceled
  scheduled_at            DateTime?
  post_id                 String?
  broadcast_all           Int       @default(0)
  visible_to_friends      Int       @default(0)
  attributed_community_id String?
  last_error              String?
  created_at              DateTime
  updated_at              DateTime

  // Relations
  author    users        @relation(fields: [author_id], references: [id], onDelete: Cascade)
  community communities? @relation(fields: [community_id], references: [id], onDelete: Cascade)

  @@index([status, scheduled_at])
  @@map("post_plans")
}

model post_reactions {
  id         String   @id
  post_id    String
  user_id    String
  emoji      String
  created_at DateTime

  // ActivityPub fields
  ap_activity_id String? @unique // Like Activity URI

  // Relations
  post posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("post_reactions")
}

model post_reposts {
  id             String   @id
  post_id        String
  user_id        String
  comment        String   @default("")
  created_at     DateTime
  ap_activity_id String?  @unique

  // Relations
  post posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([post_id, user_id])
  @@index([user_id, created_at])
  @@index([post_id, created_at])
  @@map("post_reposts")
}

model post_bookmarks {
  id         String   @id
  post_id    String
  user_id    String
  created_at DateTime

  // Relations
  post posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([post_id, user_id])
  @@index([user_id, created_at])
  @@map("post_bookmarks")
}

model comments {
  id         String   @id
  post_id    String
  author_id  String
  text       String
  created_at DateTime

  // ActivityPub fields
  ap_object_id   String? @unique // ActivityPub Object URI
  ap_activity_id String? @unique // Create Activity URI

  // Relations
  post   posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  author users @relation(fields: [author_id], references: [id], onDelete: Cascade)

  @@map("comments")
}

model media {
  key          String   @id
  user_id      String
  url          String
  description  String   @default("")
  content_type String   @default("")
  created_at   DateTime
  updated_at   DateTime

  @@index([user_id])
  @@map("media")
}

model post_edit_history {
  id                  String   @id
  post_id             String
  editor_id           String
  previous_text       String   @default("")
  previous_media_json String   @default("[]")
  diff_json           String   @default("{}")
  created_at          DateTime @default(now())

  post   posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  editor users @relation(fields: [editor_id], references: [id], onDelete: Cascade)

  @@index([post_id, created_at])
  @@map("post_edit_history")
}

model post_polls {
  id              String    @id
  post_id         String    @unique
  question        String    @default("")
  allows_multiple Int       @default(0)
  anonymous       Int       @default(1)
  expires_at      DateTime?
  created_at      DateTime  @default(now())

  post    posts               @relation(fields: [post_id], references: [id], onDelete: Cascade)
  options post_poll_options[]
  votes   post_poll_votes[]

  @@map("post_polls")
}

model post_poll_options {
  id          String   @id
  poll_id     String
  text        String
  order_index Int      @default(0)
  created_at  DateTime @default(now())

  poll  post_polls        @relation(fields: [poll_id], references: [id], onDelete: Cascade)
  votes post_poll_votes[]

  @@index([poll_id])
  @@map("post_poll_options")
}

model post_poll_votes {
  id         String   @id
  poll_id    String
  option_id  String
  user_id    String
  created_at DateTime @default(now())

  poll   post_polls        @relation(fields: [poll_id], references: [id], onDelete: Cascade)
  option post_poll_options @relation(fields: [option_id], references: [id], onDelete: Cascade)
  user   users             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([poll_id, user_id, option_id])
  @@index([poll_id])
  @@map("post_poll_votes")
}

model hashtags {
  id         String   @id
  tag        String   @unique
  created_at DateTime @default(now())

  posts post_hashtags[]

  @@map("hashtags")
}

model post_hashtags {
  post_id    String
  hashtag_id String
  created_at DateTime @default(now())

  post    posts    @relation(fields: [post_id], references: [id], onDelete: Cascade)
  hashtag hashtags @relation(fields: [hashtag_id], references: [id], onDelete: Cascade)

  @@id([post_id, hashtag_id])
  @@map("post_hashtags")
}

model post_mentions {
  post_id           String
  mentioned_user_id String
  created_at        DateTime @default(now())

  post           posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  mentioned_user users @relation(fields: [mentioned_user_id], references: [id], onDelete: Cascade)

  @@id([post_id, mentioned_user_id])
  @@map("post_mentions")
}

model stories {
  id                      String   @id
  community_id            String?
  author_id               String
  created_at              DateTime
  expires_at              DateTime
  items_json              String
  broadcast_all           Int      @default(1)
  visible_to_friends      Int      @default(1)
  attributed_community_id String?

  // Relations
  author    users        @relation("story_author", fields: [author_id], references: [id], onDelete: Cascade)
  community communities? @relation("community_stories", fields: [community_id], references: [id], onDelete: Cascade)

  @@map("stories")
}

model user_blocks {
  blocker_id String
  blocked_id String
  created_at DateTime @default(now())

  blocker users @relation("user_blocks_blocker", fields: [blocker_id], references: [id], onDelete: Cascade)
  blocked users @relation("user_blocks_blocked", fields: [blocked_id], references: [id], onDelete: Cascade)

  @@id([blocker_id, blocked_id])
  @@map("user_blocks")
}

model user_mutes {
  muter_id   String
  muted_id   String
  created_at DateTime @default(now())

  muter users @relation("user_mutes_muter", fields: [muter_id], references: [id], onDelete: Cascade)
  muted users @relation("user_mutes_muted", fields: [muted_id], references: [id], onDelete: Cascade)

  @@id([muter_id, muted_id])
  @@map("user_mutes")
}

model user_accounts {
  id                  String   @id
  user_id             String
  provider            String
  provider_account_id String
  created_at          DateTime @default(now())
  updated_at          DateTime @default(now())

  user users @relation(fields: [user_id], references: [id])

  @@unique([provider, provider_account_id])
  @@index([user_id])
  @@map("user_accounts")
}

model chat_dm_threads {
  id                String   @id
  participants_hash String   @unique
  participants_json String
  created_at        DateTime @default(now())

  messages chat_dm_messages[]

  @@map("chat_dm_threads")
}

model chat_dm_messages {
  id                String   @id
  thread_id         String
  author_id         String
  content_html      String
  raw_activity_json String
  created_at        DateTime @default(now())

  // Relations
  thread chat_dm_threads @relation(fields: [thread_id], references: [id], onDelete: Cascade)
  author users           @relation(fields: [author_id], references: [id], onDelete: Cascade)

  @@index([thread_id, created_at])
  @@map("chat_dm_messages")
}

model chat_channel_messages {
  id                String   @id
  community_id      String
  channel_id        String
  author_id         String
  content_html      String
  raw_activity_json String
  created_at        DateTime @default(now())

  // Relations
  author users @relation(fields: [author_id], references: [id], onDelete: Cascade)

  @@index([community_id, channel_id, created_at])
  @@map("chat_channel_messages")
}

model notifications {
  id         String   @id
  user_id    String // recipient
  type       String // 'follow_request' | 'follow_accepted' | 'like' | 'comment'
  actor_id   String
  ref_type   String // 'post' | 'comment' | 'user'
  ref_id     String
  message    String   @default("")
  created_at DateTime
  read       Int      @default(0)

  // Relations
  recipient users @relation("notification_recipient", fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model data_export_requests {
  id            String    @id
  user_id       String
  format        String    @default("json")
  status        String    @default("pending") // pending | processing | completed | failed
  attempt_count Int       @default(0)
  max_attempts  Int       @default(3)
  requested_at  DateTime
  processed_at  DateTime?
  download_url  String?
  result_json   String?
  error_message String?

  // Relations
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([user_id, requested_at])
  @@map("data_export_requests")
}

// ActivityPub Announce/Boost tracking
model ap_announces {
  id            String   @id
  activity_id   String   @unique // Announce Activity URI
  actor_id      String // Who announced/boosted
  object_id     String // Object URI (post being boosted)
  local_post_id String? // FK to posts.id if local post
  created_at    DateTime

  // Relations
  post posts? @relation(fields: [local_post_id], references: [id], onDelete: Cascade)

  @@index([local_post_id])
  @@index([actor_id])
  @@map("ap_announces")
}

model push_devices {
  id          String   @id
  user_id     String
  token       String   @unique
  platform    String
  device_name String   @default("")
  locale      String   @default("")
  created_at  DateTime
  updated_at  DateTime

  // Relations
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("push_devices")
}

model sessions {
  id         String    @id
  user_id    String
  created_at DateTime
  last_seen  DateTime
  expires_at DateTime?

  // Relations
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("sessions")
}

// ============================================
// ActivityPub Tables
// ============================================

// Remote actors (federated users from other instances)
model ap_actors {
  id              String    @id // Full Actor URI: https://bob.example.com/ap/users/bob
  handle          String // username part: bob
  domain          String // instance domain: example.com
  type            String    @default("Person") // Person, Group, Service
  display_name    String
  summary         String? // Bio/description
  icon_url        String?
  inbox_url       String
  outbox_url      String
  followers_url   String?
  following_url   String?
  public_key_pem  String // PEM format public key
  public_key_id   String // Key identifier URI
  created_at      DateTime
  updated_at      DateTime
  last_fetched_at DateTime? // Last time we fetched actor info

  @@unique([handle, domain])
  @@index([domain])
  @@map("ap_actors")
}

// Following relationships (local user follows remote actor)
model ap_follows {
  id              String    @id
  local_user_id   String // FK to users.id
  remote_actor_id String // FK to ap_actors.id
  activity_id     String    @unique // Follow Activity URI
  status          String    @default("pending") // pending, accepted, rejected
  created_at      DateTime
  accepted_at     DateTime?

  @@unique([local_user_id, remote_actor_id])
  @@index([local_user_id])
  @@index([remote_actor_id])
  @@map("ap_follows")
}

// Follower relationships (remote actor follows local user)
model ap_followers {
  id              String    @id
  local_user_id   String // FK to users.id
  remote_actor_id String // FK to ap_actors.id
  activity_id     String    @unique // Follow Activity URI
  status          String    @default("pending") // pending, accepted, rejected
  created_at      DateTime
  accepted_at     DateTime?

  @@unique([local_user_id, remote_actor_id])
  @@index([local_user_id])
  @@index([remote_actor_id])
  @@map("ap_followers")
}

// Inbox activities (received from remote instances)
model ap_inbox_activities {
  id              String    @id
  local_user_id   String // Recipient user
  remote_actor_id String? // Sender actor (nullable for certain activity types)
  activity_id     String // Activity URI
  activity_type   String // Follow, Create, Like, Announce, etc.
  activity_json   String // Full Activity JSON
  status          String    @default("pending") // pending, processing, processed, failed
  error_message   String?
  created_at      DateTime
  processed_at    DateTime?

  @@unique([local_user_id, activity_id])
  @@index([local_user_id])
  @@index([status])
  @@index([activity_id])
  @@map("ap_inbox_activities")
}

// Outbox activities (sent to remote instances)
model ap_outbox_activities {
  id            String   @id
  local_user_id String // Sender user
  activity_id   String   @unique // Activity URI
  activity_type String // Create, Update, Delete, Follow, Like, Announce, etc.
  activity_json String // Full Activity JSON
  object_id     String? // Object URI (if applicable)
  object_type   String? // Note, Article, etc.
  created_at    DateTime

  @@index([local_user_id])
  @@index([created_at])
  @@map("ap_outbox_activities")
}

// Keypairs for HTTP Signatures (one per user)
model ap_keypairs {
  user_id         String   @id // FK to users.id
  public_key_pem  String // PEM format
  private_key_pem String // PEM format (consider encryption)
  created_at      DateTime

  // Relations
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("ap_keypairs")
}

// Remote instance metadata
model ap_instances {
  domain          String   @id // e.g., mastodon.social
  software        String? // mastodon, misskey, etc.
  version         String?
  last_checked_at DateTime

  @@map("ap_instances")
}

// Delivery queue for outgoing activities
model ap_delivery_queue {
  id               String    @id
  activity_id      String // FK to ap_outbox_activities.activity_id
  target_inbox_url String
  attempts         Int       @default(0)
  max_attempts     Int       @default(3)
  status           String    @default("pending") // pending, delivered, failed
  last_attempt_at  DateTime?
  next_attempt_at  DateTime?
  error_message    String?
  created_at       DateTime
  retry_count      Int       @default(0) // For compatibility with existing code
  delivered_at     DateTime? // For compatibility with existing code
  last_error       String? // For compatibility with existing code

  @@unique([activity_id, target_inbox_url])
  @@index([status])
  @@index([next_attempt_at])
  @@map("ap_delivery_queue")
}

// Moderation reports
model reports {
  id                String   @id
  reporter_actor_id String
  target_actor_id   String
  target_object_id  String?
  reason            String?
  category          String   @default("other")
  status            String   @default("pending") // pending, reviewed, resolved, dismissed
  created_at        DateTime @default(now())
  updated_at        DateTime @default(now())

  @@index([status])
  @@index([target_actor_id])
  @@map("reports")
}

// App revision history (prod)
model app_revisions {
  id                  String   @id
  created_at          DateTime @default(now())
  author_type         String
  author_name         String?
  message             String?
  schema_version      String
  manifest_snapshot   String
  script_snapshot_ref String

  @@map("app_revisions")
}

// Single-row table tracking the currently active revision
model app_state {
  id                 Int      @id @default(1)
  active_revision_id String?
  updated_at         DateTime @default(now())

  active_revision app_revisions? @relation(fields: [active_revision_id], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@map("app_state")
}

// App workspaces (dev)
model app_workspaces {
  id               String   @id
  base_revision_id String?
  status           String   @default("draft") // draft, validated, testing, ready, applied
  author_type      String
  author_name      String?
  created_at       DateTime @default(now())
  updated_at       DateTime @default(now())

  base_revision app_revisions? @relation("AppWorkspaceBaseRevision", fields: [base_revision_id], references: [id], onDelete: SetNull, onUpdate: Cascade)
  files         app_workspace_files[]

  @@map("app_workspaces")
}

model app_workspace_files {
  workspace_id String
  path         String
  content      Bytes
  content_type String?
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now())

  workspace app_workspaces @relation(fields: [workspace_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([workspace_id, path])
  @@map("app_workspace_files")
}

// App runtime logs (dev/prod preview sandbox)
model app_debug_logs {
  id           Int      @id @default(autoincrement())
  timestamp    DateTime @default(now())
  mode         String
  workspace_id String?
  run_id       String
  handler      String?
  level        String
  message      String
  data_json    String?

  @@index([timestamp], map: "app_debug_logs_timestamp_idx")
  @@index([workspace_id], map: "app_debug_logs_workspace_idx")
  @@index([handler], map: "app_debug_logs_handler_idx")
  @@map("app_debug_logs")
}

// AI configuration (node-level)
model ai_config {
  id          String   @id
  config_json String
  updated_at  DateTime @default(now())

  @@map("ai_config")
}
